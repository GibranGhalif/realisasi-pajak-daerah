<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Realisasi Pajak Daerah</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js untuk Grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- SheetJS (XLSX) Library -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <!-- jsPDF Libraries for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Menggunakan font yang lebih modern */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style untuk sorting icon */
        .sort-icon {
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .sortable:hover .sort-icon {
            opacity: 1;
        }
        .sort-icon.active {
            opacity: 1;
        }
        /* Style untuk notifikasi */
        #notification {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- =================================== -->
    <!-- =====      HALAMAN LOGIN        ===== -->
    <!-- =================================== -->
    <div id="login-view" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Login ke Dashboard
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Realisasi Pajak Daerah
                </p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div id="login-error" class="hidden p-3 bg-red-100 text-red-700 rounded-lg text-sm">
                    Username atau password salah!
                </div>
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="username" class="sr-only">Username</label>
                        <input id="username" name="username" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Username">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Password">
                    </div>
                </div>
                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Masuk
                    </button>
                </div>
                 <div class="text-center text-xs text-gray-500">
                    <p>Gunakan <strong>username:</strong> admin & <strong>password:</strong> admin</p>
                </div>
            </form>
        </div>
    </div>

    <!-- =================================== -->
    <!-- =====      APLIKASI UTAMA       ===== -->
    <!-- =================================== -->
    <div id="main-app" class="hidden">
        <!-- Notifikasi -->
        <div id="notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-[-20px]">
            Data berhasil disimpan!
        </div>

        <!-- Modal Konfirmasi Hapus -->
        <div id="delete-confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                        <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
                    </div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Hapus Transaksi</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500">
                            Apakah Anda yakin ingin menghapus transaksi ini? Tindakan ini tidak dapat dibatalkan.
                        </p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="confirm-delete-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">
                            Ya, Hapus
                        </button>
                        <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-900 text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            Batal
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            
            <!-- --- Header & Tombol Navigasi --- -->
            <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900">Dashboard Realisasi Pajak Daerah</h1>
                    <p class="text-lg text-gray-600 mt-1">Analisis Pencapaian Target & Realisasi PAD</p>
                </div>
                <div class="mt-4 sm:mt-0 flex space-x-2">
                    <button id="btn-dashboard" class="bg-blue-500 text-white py-2 px-4 rounded-lg shadow hover:bg-blue-600 transition">Dashboard</button>
                    <button id="btn-input" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition">Input Data</button>
                    <button id="btn-recap" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition">Rekap Transaksi</button>
                </div>
            </header>

            <!-- BAGIAN DASHBOARD -->
            <div id="dashboard-view">
                <!-- Ringkasan KPI -->
                <div id="kpi-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>
                
                <!-- Realisasi Harian dan Bulanan -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Realisasi Hari Ini</h2>
                        <div id="today-realization-list" class="space-y-3 max-h-[300px] overflow-y-auto pr-2">
                            <!-- Daftar realisasi hari ini akan dirender di sini -->
                        </div>
                        <div id="today-total" class="mt-4 pt-4 border-t border-gray-200 text-right font-bold text-lg">
                            <!-- Total hari ini akan dirender di sini -->
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Grafik Realisasi per Bulan</h2>
                        <div class="h-[318px]">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Grafik Realisasi Pajak -->
                <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                    <h2 class="text-2xl font-bold mb-6">Grafik Realisasi vs Target per Jenis Pajak</h2>
                    <div class="h-[400px]">
                        <canvas id="taxChart"></canvas>
                    </div>
                </div>
                <!-- Tabel Detail Pajak -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Rincian Realisasi Pajak Daerah</h2>
                        <div class="relative inline-block text-left">
                            <div>
                                <button type="button" id="download-menu-button" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-indigo-500">
                                    Download
                                    <i data-lucide="chevron-down" class="w-5 h-5 ml-2 -mr-1"></i>
                                </button>
                            </div>
                            <div id="download-menu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10" role="menu" aria-orientation="vertical" aria-labelledby="download-menu-button">
                                <div class="py-1" role="none">
                                    <a href="#" id="download-xlsx" class="text-gray-700 group flex items-center px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">
                                        <i data-lucide="file-spreadsheet" class="w-5 h-5 mr-3 text-green-600"></i>
                                        Download .xlsx
                                    </a>
                                    <a href="#" id="download-pdf" class="text-gray-700 group flex items-center px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">
                                        <i data-lucide="file-text" class="w-5 h-5 mr-3 text-red-600"></i>
                                        Download .pdf
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b-2 border-gray-200 bg-gray-100">
                                    <th class="p-4 text-sm font-semibold text-gray-600 cursor-pointer sortable" data-sort-key="name"><div class="flex items-center">Nama Pajak <span class="ml-2 sort-icon" data-icon-key="name"></span></div></th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Target</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Realisasi</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Sisa Target</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600 cursor-pointer sortable" data-sort-key="percentage"><div class="flex items-center">Persentase <span class="ml-2 sort-icon" data-icon-key="percentage"></span></div></th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Status</th>
                                </tr>
                            </thead>
                            <tbody id="tax-table-body"></tbody>
                            <tfoot id="tax-table-foot"></tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- BAGIAN INPUT DATA -->
            <div id="input-view" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Form Input Target -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-6">Input Target Pajak</h2>
                        <form id="form-target">
                            <div id="target-input-fields" class="space-y-4 max-h-[600px] overflow-y-auto pr-2"></div>
                            <button type="submit" class="mt-6 w-full bg-blue-500 text-white py-3 px-4 rounded-lg shadow font-semibold hover:bg-blue-600 transition">Simpan Perubahan Target</button>
                        </form>
                    </div>
                    <!-- Form Input Realisasi -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-6">Input Realisasi Transaksi</h2>
                        <form id="form-realization" class="space-y-4">
                            <div><label for="taxpayer-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Wajib Pajak</label><input type="text" id="taxpayer-name" placeholder="Masukkan Nama WP" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></div>
                            <div><label for="business-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Usaha</label><input type="text" id="business-name" placeholder="Masukkan Nama Usaha" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></div>
                            <div><label for="realization-tax-type" class="block text-sm font-medium text-gray-700 mb-1">Jenis Pajak</label><select id="realization-tax-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></select></div>
                            <div id="sub-tax-type-container" class="hidden"><label for="sub-tax-type" class="block text-sm font-medium text-gray-700 mb-1">Subjenis Pajak</label><select id="sub-tax-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></select></div>
                            <div><label for="realization-amount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Realisasi Pokok (Rp)</label><input type="number" id="realization-amount" placeholder="Contoh: 5000000" min="0" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></div>
                            <div><label for="fine-amount" class="block text-sm font-medium text-gray-700 mb-1">Nilai Denda (Rp)</label><input type="number" id="fine-amount" placeholder="Kosongkan jika tidak ada" min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></div>
                            <div><label for="transaction-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Transaksi</label><input type="date" id="transaction-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></div>
                            <div><label for="payment-method" class="block text-sm font-medium text-gray-700 mb-1">Jenis Pembayaran/Penyetoran</label><select id="payment-method" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"><option>Transfer Bank</option><option>Tunai</option><option>QRIS</option><option>E-Wallet</option><option>Lainnya</option></select></div>
                            <div><label for="tax-description" class="block text-sm font-medium text-gray-700 mb-1">Keterangan Pajak</label><select id="tax-description" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"><option>Pokok</option><option>Tunggakan</option></select></div>
                            <button type="submit" class="w-full bg-green-500 text-white py-3 px-4 rounded-lg shadow font-semibold hover:bg-green-600 transition !mt-6">Tambah Realisasi</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- BAGIAN REKAP TRANSAKSI -->
            <div id="recap-view" class="hidden">
                 <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold">Rekapitulasi Transaksi Realisasi</h2>
                        <div class="flex items-center gap-4 flex-wrap">
                            <div>
                                <label for="start-date" class="text-sm font-medium text-gray-700">Tgl Awal</label>
                                <input type="date" id="start-date" class="p-2 border border-gray-300 rounded-lg">
                            </div>
                             <div>
                                <label for="end-date" class="text-sm font-medium text-gray-700">Tgl Akhir</label>
                                <input type="date" id="end-date" class="p-2 border border-gray-300 rounded-lg">
                            </div>
                             <div class="relative inline-block text-left pt-5">
                                <div>
                                    <button type="button" id="recap-download-menu-button" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-indigo-500">
                                        Download
                                        <i data-lucide="chevron-down" class="w-5 h-5 ml-2 -mr-1"></i>
                                    </button>
                                </div>
                                <div id="recap-download-menu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10" role="menu" aria-orientation="vertical" aria-labelledby="recap-download-menu-button">
                                    <div class="py-1" role="none">
                                        <a href="#" id="recap-download-xlsx" class="text-gray-700 group flex items-center px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">
                                            <i data-lucide="file-spreadsheet" class="w-5 h-5 mr-3 text-green-600"></i>
                                            Download .xlsx
                                        </a>
                                        <a href="#" id="recap-download-pdf" class="text-gray-700 group flex items-center px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">
                                            <i data-lucide="file-text" class="w-5 h-5 mr-3 text-red-600"></i>
                                            Download .pdf
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b-2 border-gray-200 bg-gray-100">
                                    <th class="p-4 text-sm font-semibold text-gray-600">Tanggal</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Nama WP</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Nama Usaha</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Jenis Pajak</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Jumlah Pokok</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Denda</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Total Bayar</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="recap-table-body">
                                <!-- Data rekap akan di-render di sini -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <footer class="text-center mt-12 text-gray-500 text-sm">
                <p>Aplikasi Dashboard Realisasi Pajak Daerah &copy; <span id="year"></span></p>
                <p>Dibuat untuk keperluan simulasi dan visualisasi data.</p>
            </footer>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Data Pajak Awal (Contoh) ---
            let taxData = [
                { id: 1, name: 'Pajak Reklame', target: 15000000000, realization: 0 },
                { id: 2, name: 'Pajak Air Tanah', target: 8000000000, realization: 0 },
                { id: 3, name: 'Pajak Sarang Burung Walet', target: 500000000, realization: 0 },
                { id: 4, name: 'Pajak Mineral Non Logam', target: 12000000000, realization: 0 },
                { id: 5, name: 'PBB-P2', target: 150000000000, realization: 0 },
                { id: 6, name: 'BPHTB', target: 200000000000, realization: 0 },
                { id: 7, name: 'PBJT Makanan & Minuman', target: 95000000000, realization: 0 },
                { id: 8, name: 'PBJT Jasa Hiburan', target: 25000000000, realization: 0 },
                { id: 9, name: 'PBJT Jasa Perhotelan', target: 75000000000, realization: 0 },
                { id: 10, name: 'PBJT Tenaga Listrik', target: 60000000000, realization: 0 },
                { id: 11, name: 'Opsen PKB', target: 45000000000, realization: 0 },
                { id: 12, name: 'Opsen BBNKB', target: 50000000000, realization: 0 },
                { id: 13, name: 'PBJT Jasa Parkir', target: 20000000000, realization: 0 },
            ];
            
            let transactionLog = [];

            const subTaxTypes = {
              1: ["Reklame papan billboard/videotron/megatron", "Reklame kain", "Reklame melekat/stiker", "Reklame selebaran", "Reklame berjalan, termasuk pada kendaraan", "Reklame udara", "Reklame apung", "Reklame film/slide", "Reklame peragaan"],
              2: ["Pengambilan Air Permukaan", "Pengambilan Air Bawah Tanah"],
              4: ["Pasir", "Kerikil", "Batu Kapur", "Tanah Liat"],
              5: ["Perdesaan", "Perkotaan"],
              6: ["Jual beli", "Tukar-menukar", "Hibah", "Hibah wasiat", "Waris", "Pemasukan dalam perseroan/badan hukum", "Pemisahan hak yang mengakibatkan peralihan", "Penunjukan pembeli dalam lelang", "Pelaksanaan putusan hakim", "Penggabungan usaha", "Peleburan usaha", "Pemekaran usaha", "Hadiah", "Pemberian hak baru (kelanjutan pelepasan hak)", "Pemberian hak baru (di luar pelepasan hak)"],
              7: ["Restoran", "Rumah Makan", "Kafetaria", "Jasa Boga/Katering"],
              8: ["Bioskop", "Pagelaran Musik/Tari", "Karaoke", "Permainan Biliar"],
              9: ["Hotel Bintang 5", "Hotel Bintang 4", "Hotel Bintang 3", "Hotel Melati", "Wisma/Losmen"],
              10: ["Konsumsi Listrik dari PLN", "Konsumsi Listrik dari Non-PLN"],
              13: ["Parkir Gedung/Gedung Parkir", "Parkir Pelataran/Lapangan", "Jasa Valet Parking", "Parkir Inap"],
            };

            let sortConfig = { key: 'name', direction: 'ascending' };
            let taxChartInstance = null;
            let monthlyChartInstance = null;
            let transactionToDeleteId = null;

            // --- Elemen DOM ---
            const loginView = document.getElementById('login-view');
            const mainApp = document.getElementById('main-app');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');

            const dashboardView = document.getElementById('dashboard-view');
            const inputView = document.getElementById('input-view');
            const recapView = document.getElementById('recap-view');
            const btnDashboard = document.getElementById('btn-dashboard');
            const btnInput = document.getElementById('btn-input');
            const btnRecap = document.getElementById('btn-recap');
            const notification = document.getElementById('notification');
            
            const kpiContainer = document.getElementById('kpi-cards');
            const tableBody = document.getElementById('tax-table-body');
            const tableFoot = document.getElementById('tax-table-foot');
            const chartCanvas = document.getElementById('taxChart').getContext('2d');
            const monthlyChartCanvas = document.getElementById('monthlyChart').getContext('2d');
            const todayList = document.getElementById('today-realization-list');
            const todayTotal = document.getElementById('today-total');
            
            const formTarget = document.getElementById('form-target');
            const targetInputFields = document.getElementById('target-input-fields');
            const formRealization = document.getElementById('form-realization');
            const realizationTaxTypeSelect = document.getElementById('realization-tax-type');
            const realizationAmountInput = document.getElementById('realization-amount');
            const fineAmountInput = document.getElementById('fine-amount');
            const taxpayerNameInput = document.getElementById('taxpayer-name');
            const businessNameInput = document.getElementById('business-name');
            const transactionDateInput = document.getElementById('transaction-date');
            const subTaxTypeContainer = document.getElementById('sub-tax-type-container');
            const subTaxTypeSelect = document.getElementById('sub-tax-type');
            const downloadMenuButton = document.getElementById('download-menu-button');
            const downloadMenu = document.getElementById('download-menu');
            const downloadXlsxBtn = document.getElementById('download-xlsx');
            const downloadPdfBtn = document.getElementById('download-pdf');
            const recapTableBody = document.getElementById('recap-table-body');
            const recapDownloadMenuButton = document.getElementById('recap-download-menu-button');
            const recapDownloadMenu = document.getElementById('recap-download-menu');
            const recapDownloadXlsxBtn = document.getElementById('recap-download-xlsx');
            const recapDownloadPdfBtn = document.getElementById('recap-download-pdf');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');


            document.getElementById('year').textContent = new Date().getFullYear();

            // --- Fungsi Helper ---
            const formatCurrency = (amount) => {
                if (amount >= 1_000_000_000) {
                    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', notation: 'compact', compactDisplay: 'short' }).format(amount);
                }
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
            }
            
            const formatFullCurrency = (amount) => {
                 return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
            }

            const getRealizationStatusHTML = (percentage) => {
                let statusClass = '', statusText = '';
                if (percentage >= 100) { statusClass = 'bg-green-100 text-green-800'; statusText = 'Tercapai'; } 
                else if (percentage >= 80) { statusClass = 'bg-yellow-100 text-yellow-800'; statusText = 'Proses'; } 
                else { statusClass = 'bg-red-100 text-red-800'; statusText = 'Kurang'; }
                return `<span class="px-3 py-1 text-sm font-medium rounded-full ${statusClass}">${statusText}</span>`;
            };

            const createKpiCardHTML = (title, value, iconName, color, gradient) => `
                <div class="relative p-6 rounded-2xl shadow-lg overflow-hidden transition-transform transform hover:-translate-y-2 bg-white">
                    <div class="absolute -top-4 -right-4 w-24 h-24 rounded-full ${gradient} opacity-20"></div>
                    <div class="relative z-10">
                        <div class="p-3 inline-block rounded-xl ${color}">
                            <i data-lucide="${iconName}" class="text-white w-8 h-8"></i>
                        </div>
                        <p class="mt-4 text-lg text-gray-500">${title}</p>
                        <p class="text-2xl font-extrabold text-gray-800 mt-1">${value}</p>
                    </div>
                </div>
            `;
            
            const showNotification = (message, isError = false) => {
                notification.textContent = message;
                notification.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-[-20px] ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                notification.classList.remove('opacity-0', 'translate-y-[-20px]');
                notification.classList.add('opacity-100', 'translate-y-0');
                setTimeout(() => {
                    notification.classList.remove('opacity-100', 'translate-y-0');
                    notification.classList.add('opacity-0', 'translate-y-[-20px]');
                }, 3000);
            };

            // --- Logika Navigasi ---
            function switchView(view) {
                const views = {
                    dashboard: dashboardView,
                    input: inputView,
                    recap: recapView
                };
                const buttons = {
                    dashboard: btnDashboard,
                    input: btnInput,
                    recap: btnRecap
                };

                // Hide all views
                Object.values(views).forEach(v => v.classList.add('hidden'));
                // Reset all button styles
                Object.values(buttons).forEach(b => {
                    b.classList.replace('bg-blue-500', 'bg-gray-200');
                    b.classList.replace('text-white', 'text-gray-700');
                });

                // Show the selected view and update its button style
                views[view].classList.remove('hidden');
                buttons[view].classList.replace('bg-gray-200', 'bg-blue-500');
                buttons[view].classList.replace('text-gray-700', 'text-white');

                // Render specific content for the view
                if (view === 'input') {
                    renderInputForms();
                } else if (view === 'recap') {
                    filterAndRenderRecap();
                }
            }

            // --- Fungsi Render ---
            function renderAll() {
                renderKpiCards();
                renderTable();
                renderChart();
                renderTodayRealization();
                renderMonthlyChart();
                updateSortIcons();
                lucide.createIcons();
            }

            function renderKpiCards() {
                const totalTarget = taxData.reduce((sum, item) => sum + item.target, 0);
                const totalRealization = taxData.reduce((sum, item) => sum + item.realization, 0);
                const overallPercentage = totalTarget > 0 ? (totalRealization / totalTarget) * 100 : 0;
                kpiContainer.innerHTML = 
                    createKpiCardHTML('Total Target', formatCurrency(totalTarget), 'target', 'bg-blue-500', 'bg-gradient-to-br from-blue-200 to-blue-50') +
                    createKpiCardHTML('Total Realisasi', formatCurrency(totalRealization), 'dollar-sign', 'bg-green-500', 'bg-gradient-to-br from-green-200 to-green-50') +
                    createKpiCardHTML('Persentase Realisasi', `${overallPercentage.toFixed(2)}%`, 'bar-chart-2', 'bg-yellow-500', 'bg-gradient-to-br from-yellow-200 to-yellow-50') +
                    createKpiCardHTML('Wajib Pajak Terdaftar', '125.430', 'users', 'bg-indigo-500', 'bg-gradient-to-br from-indigo-200 to-indigo-50');
            }

            function renderTable() {
                const sortedData = getSortedData();
                tableBody.innerHTML = sortedData.map(tax => {
                    const percentage = tax.target > 0 ? (tax.realization / tax.target) * 100 : 0;
                    const sisaTarget = Math.max(0, tax.target - tax.realization);
                    return `
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="p-4 font-medium">${tax.name}</td>
                            <td class="p-4 text-gray-600">${formatFullCurrency(tax.target)}</td>
                            <td class="p-4 text-gray-600">${formatFullCurrency(tax.realization)}</td>
                            <td class="p-4 text-orange-600 font-medium">${formatFullCurrency(sisaTarget)}</td>
                            <td class="p-4">
                                <div class="flex items-center">
                                    <div class="w-full bg-gray-200 rounded-full h-2.5 mr-3"><div class="h-2.5 rounded-full ${percentage >= 100 ? 'bg-green-500' : 'bg-blue-500'}" style="width: ${Math.min(percentage, 100)}%"></div></div>
                                    <span class="font-medium">${percentage.toFixed(2)}%</span>
                                </div>
                            </td>
                            <td class="p-4">${getRealizationStatusHTML(percentage)}</td>
                        </tr>`;
                }).join('');
                
                const totalTarget = taxData.reduce((sum, item) => sum + item.target, 0);
                const totalRealization = taxData.reduce((sum, item) => sum + item.realization, 0);
                const totalSisaTarget = Math.max(0, totalTarget - totalRealization);
                const overallPercentage = totalTarget > 0 ? (totalRealization / totalTarget) * 100 : 0;
                
                tableFoot.innerHTML = `
                    <tr class="font-bold bg-gray-100">
                        <td class="p-4">TOTAL</td>
                        <td class="p-4">${formatFullCurrency(totalTarget)}</td>
                        <td class="p-4">${formatFullCurrency(totalRealization)}</td>
                        <td class="p-4 text-orange-700">${formatFullCurrency(totalSisaTarget)}</td>
                        <td class="p-4" colspan="2">
                            <div class="flex items-center">
                                <div class="w-full bg-gray-300 rounded-full h-3 mr-3"><div class="h-3 rounded-full ${overallPercentage >= 100 ? 'bg-green-600' : 'bg-blue-600'}" style="width: ${Math.min(overallPercentage, 100)}%"></div></div>
                                <span class="font-bold text-lg">${overallPercentage.toFixed(2)}%</span>
                            </div>
                        </td>
                    </tr>`;
            }

            function renderChart() {
                if (taxChartInstance) taxChartInstance.destroy();
                taxChartInstance = new Chart(chartCanvas, {
                    type: 'bar',
                    data: {
                        labels: taxData.map(d => d.name),
                        datasets: [
                            { label: 'Target', data: taxData.map(d => d.target), backgroundColor: '#60a5fa', borderRadius: 8 },
                            { label: 'Realisasi', data: taxData.map(d => d.realization), backgroundColor: '#4ade80', borderRadius: 8 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { callback: (value) => new Intl.NumberFormat('id-ID', { notation: 'compact', compactDisplay: 'short' }).format(value), color: '#4A5568' }, grid: { color: '#e0e0e0', borderDash: [3, 3] } },
                            x: { ticks: { color: '#4A5568', maxRotation: 15, minRotation: 15 }, grid: { display: false } }
                        },
                        plugins: {
                            legend: { position: 'top', labels: { padding: 20, font: { size: 14 } } },
                            tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${formatFullCurrency(context.raw)}` }, backgroundColor: 'rgba(255, 255, 255, 0.9)', titleColor: '#333', bodyColor: '#333', borderColor: '#ccc', borderWidth: 1, borderRadius: 10, padding: 10 }
                        }
                    }
                });
            }

            function renderTodayRealization() {
                const today = new Date().toISOString().slice(0, 10);
                const todayTransactions = transactionLog.filter(log => log.transactionDate === today);

                if (todayTransactions.length === 0) {
                    todayList.innerHTML = `<p class="text-gray-500 text-center py-8">Belum ada realisasi hari ini.</p>`;
                    todayTotal.innerHTML = `Total Hari Ini: ${formatFullCurrency(0)}`;
                    return;
                }

                todayList.innerHTML = todayTransactions.map(log => `
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">${log.taxName}</span>
                        <span class="font-semibold">${formatFullCurrency(log.totalPayment)}</span>
                    </div>
                `).join('');

                const total = todayTransactions.reduce((sum, log) => sum + log.totalPayment, 0);
                todayTotal.innerHTML = `Total Hari Ini: ${formatFullCurrency(total)}`;
            }

            function renderMonthlyChart() {
                const monthlyData = transactionLog.reduce((acc, log) => {
                    const month = log.transactionDate.slice(0, 7); // YYYY-MM
                    if (!acc[month]) {
                        acc[month] = 0;
                    }
                    acc[month] += log.totalPayment;
                    return acc;
                }, {});

                const sortedMonths = Object.keys(monthlyData).sort();
                
                const labels = sortedMonths.map(month => {
                    const [year, monthNum] = month.split('-');
                    const date = new Date(year, monthNum - 1);
                    return date.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
                });
                const data = sortedMonths.map(month => monthlyData[month]);

                if (monthlyChartInstance) monthlyChartInstance.destroy();
                monthlyChartInstance = new Chart(monthlyChartCanvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Realisasi per Bulan',
                            data: data,
                            fill: true,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => new Intl.NumberFormat('id-ID', { notation: 'compact', compactDisplay: 'short' }).format(value)
                                }
                            }
                        }
                    }
                });
            }

            function renderInputForms() {
                targetInputFields.innerHTML = taxData.map(tax => `
                    <div>
                        <label for="target-${tax.id}" class="block text-sm font-medium text-gray-700">${tax.name}</label>
                        <input type="number" id="target-${tax.id}" data-id="${tax.id}" value="${tax.target}" min="0" required class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                `).join('');

                realizationTaxTypeSelect.innerHTML = taxData.map(tax => `<option value="${tax.id}">${tax.name}</option>`).join('');
                transactionDateInput.valueAsDate = new Date();
                updateSubTaxOptions();
            }

            function filterAndRenderRecap() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;

                let filteredLogs = transactionLog;

                if (startDate && endDate) {
                    filteredLogs = transactionLog.filter(log => {
                        return log.transactionDate >= startDate && log.transactionDate <= endDate;
                    });
                } else if (startDate) {
                     filteredLogs = transactionLog.filter(log => log.transactionDate >= startDate);
                } else if (endDate) {
                     filteredLogs = transactionLog.filter(log => log.transactionDate <= endDate);
                }

                if (filteredLogs.length === 0) {
                    recapTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-8 text-gray-500">Tidak ada transaksi pada rentang tanggal yang dipilih.</td></tr>`;
                    return;
                }

                recapTableBody.innerHTML = filteredLogs.map(log => `
                     <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="p-4">${log.transactionDate}</td>
                        <td class="p-4">${log.taxpayerName}</td>
                        <td class="p-4">${log.businessName}</td>
                        <td class="p-4">${log.taxName}</td>
                        <td class="p-4 text-right">${formatFullCurrency(log.amount)}</td>
                        <td class="p-4 text-right">${formatFullCurrency(log.fineAmount)}</td>
                        <td class="p-4 text-right font-semibold">${formatFullCurrency(log.totalPayment)}</td>
                        <td class="p-4 text-center">
                            <button class="delete-transaction-btn p-2 text-red-600 hover:text-red-800" data-id="${log.id}">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                lucide.createIcons();
            }

            function updateSubTaxOptions() {
                const selectedTaxId = realizationTaxTypeSelect.value;
                const subtypes = subTaxTypes[selectedTaxId] || [];

                if (subtypes.length > 0) {
                    subTaxTypeSelect.innerHTML = subtypes.map(subtype => `<option>${subtype}</option>`).join('');
                    subTaxTypeContainer.classList.remove('hidden');
                } else {
                    subTaxTypeContainer.classList.add('hidden');
                    subTaxTypeSelect.innerHTML = '';
                }
            }
            
            // --- Logika Sorting ---
            function updateSortIcons() {
                document.querySelectorAll('.sort-icon').forEach(icon => {
                    const key = icon.getAttribute('data-icon-key');
                    if (key === sortConfig.key) {
                        icon.innerHTML = sortConfig.direction === 'ascending' ? '<i data-lucide="chevron-up" class="w-4 h-4"></i>' : '<i data-lucide="chevron-down" class="w-4 h-4"></i>';
                        icon.classList.add('active');
                    } else {
                        icon.innerHTML = '<i data-lucide="chevron-down" class="w-4 h-4"></i>';
                        icon.classList.remove('active');
                    }
                });
                lucide.createIcons();
            }

            function getSortedData() {
                return [...taxData].sort((a, b) => {
                    let aValue, bValue;
                    if (sortConfig.key === 'name') { aValue = a.name; bValue = b.name; } 
                    else { aValue = a.target > 0 ? a.realization / a.target : 0; bValue = b.target > 0 ? b.realization / b.target : 0; }
                    if (aValue < bValue) return sortConfig.direction === 'ascending' ? -1 : 1;
                    if (aValue > bValue) return sortConfig.direction === 'ascending' ? 1 : -1;
                    return 0;
                });
            }

            // --- Logika Hapus ---
            function showDeleteModal(transactionId) {
                transactionToDeleteId = transactionId;
                deleteConfirmModal.classList.remove('hidden');
            }

            function hideDeleteModal() {
                transactionToDeleteId = null;
                deleteConfirmModal.classList.add('hidden');
            }

            function deleteTransaction() {
                if (!transactionToDeleteId) return;

                const transactionIndex = transactionLog.findIndex(log => log.id === transactionToDeleteId);
                if (transactionIndex === -1) return;

                const transaction = transactionLog[transactionIndex];
                const taxItem = taxData.find(t => t.id === transaction.taxId);
                if (taxItem) {
                    taxItem.realization -= transaction.totalPayment;
                }

                transactionLog.splice(transactionIndex, 1);
                
                hideDeleteModal();
                renderAll();
                filterAndRenderRecap();
                showNotification("Transaksi berhasil dihapus.");
            }

            // --- Event Listeners ---
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = e.target.username.value;
                const password = e.target.password.value;

                if (username === 'admin' && password === 'admin') {
                    loginView.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    initDashboard();
                } else {
                    loginError.classList.remove('hidden');
                }
            });

            function downloadXLSX() {
                const dataToExport = getSortedData().map(tax => {
                    const percentage = tax.target > 0 ? (tax.realization / tax.target) * 100 : 0;
                    const sisaTarget = Math.max(0, tax.target - tax.realization);
                    let status = '';
                    if (percentage >= 100) status = 'Tercapai';
                    else if (percentage >= 80) status = 'Proses';
                    else status = 'Kurang';

                    return {
                        "Nama Pajak": tax.name,
                        "Target": tax.target,
                        "Realisasi": tax.realization,
                        "Sisa Target": sisaTarget,
                        "Persentase (%)": parseFloat(percentage.toFixed(2)),
                        "Status": status,
                    };
                });

                const totalTarget = taxData.reduce((sum, item) => sum + item.target, 0);
                const totalRealization = taxData.reduce((sum, item) => sum + item.realization, 0);
                const totalSisaTarget = Math.max(0, totalTarget - totalRealization);
                const overallPercentage = totalTarget > 0 ? (totalRealization / totalTarget) * 100 : 0;

                dataToExport.push({}); // Add a blank row for spacing
                dataToExport.push({
                    "Nama Pajak": "TOTAL",
                    "Target": totalTarget,
                    "Realisasi": totalRealization,
                    "Sisa Target": totalSisaTarget,
                    "Persentase (%)": parseFloat(overallPercentage.toFixed(2)),
                    "Status": "",
                });

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Realisasi Pajak");
                
                worksheet["!cols"] = [ { wch: 35 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 15 }, { wch: 15 } ];

                XLSX.writeFile(workbook, "Rincian_Realisasi_Pajak_Daerah.xlsx");
            }
            
            function downloadPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const tableData = getSortedData().map(tax => {
                    const percentage = tax.target > 0 ? (tax.realization / tax.target) * 100 : 0;
                    const sisaTarget = Math.max(0, tax.target - tax.realization);
                    let status = '';
                    if (percentage >= 100) status = 'Tercapai';
                    else if (percentage >= 80) status = 'Proses';
                    else status = 'Kurang';
                    
                    return [
                        tax.name,
                        formatFullCurrency(tax.target),
                        formatFullCurrency(tax.realization),
                        formatFullCurrency(sisaTarget),
                        `${percentage.toFixed(2)}%`,
                        status
                    ];
                });

                const totalTarget = taxData.reduce((sum, item) => sum + item.target, 0);
                const totalRealization = taxData.reduce((sum, item) => sum + item.realization, 0);
                const totalSisaTarget = Math.max(0, totalTarget - totalRealization);
                const overallPercentage = totalTarget > 0 ? (totalRealization / totalTarget) * 100 : 0;
                
                const totalRow = [
                    { content: 'TOTAL', colSpan: 1, styles: { fontStyle: 'bold', fillColor: '#f0f0f0' } },
                    { content: formatFullCurrency(totalTarget), styles: { fontStyle: 'bold', halign: 'right', fillColor: '#f0f0f0' } },
                    { content: formatFullCurrency(totalRealization), styles: { fontStyle: 'bold', halign: 'right', fillColor: '#f0f0f0' } },
                    { content: formatFullCurrency(totalSisaTarget), styles: { fontStyle: 'bold', halign: 'right', fillColor: '#f0f0f0' } },
                    { content: `${overallPercentage.toFixed(2)}%`, styles: { fontStyle: 'bold', halign: 'center', fillColor: '#f0f0f0' } },
                    { content: '', styles: { fontStyle: 'bold', fillColor: '#f0f0f0' } },
                ];

                doc.setFontSize(18);
                doc.text("Rincian Realisasi Pajak Daerah", 14, 22);
                doc.setFontSize(11);
                doc.setTextColor(100);
                const tgl = new Date();
                doc.text(`Diunduh pada: ${tgl.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}`, 14, 29);

                doc.autoTable({
                    head: [['Nama Pajak', 'Target', 'Realisasi', 'Sisa Target', 'Persentase', 'Status']],
                    body: tableData,
                    foot: [totalRow],
                    startY: 35,
                    theme: 'grid',
                    headStyles: { fillColor: [22, 160, 133], textColor: 255 },
                    footStyles: { textColor: 0, fontStyle: 'bold' },
                    styles: { halign: 'left' },
                    columnStyles: {
                        1: { halign: 'right' },
                        2: { halign: 'right' },
                        3: { halign: 'right' },
                        4: { halign: 'center' },
                        5: { halign: 'center' },
                    }
                });

                doc.save('Rincian_Realisasi_Pajak_Daerah.pdf');
            }

            function getFilteredRecapData() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                let filteredLogs = transactionLog;

                if (startDate && endDate) {
                    filteredLogs = transactionLog.filter(log => log.transactionDate >= startDate && log.transactionDate <= endDate);
                } else if (startDate) {
                     filteredLogs = transactionLog.filter(log => log.transactionDate >= startDate);
                } else if (endDate) {
                     filteredLogs = transactionLog.filter(log => log.transactionDate <= endDate);
                }
                return filteredLogs;
            }

            function downloadRecapXLSX() {
                const dataToExport = getFilteredRecapData().map(log => ({
                    "Tanggal": log.transactionDate,
                    "Nama WP": log.taxpayerName,
                    "Nama Usaha": log.businessName,
                    "Jenis Pajak": log.taxName,
                    "Subjenis Pajak": log.subTax,
                    "Jumlah Pokok": log.amount,
                    "Denda": log.fineAmount,
                    "Total Bayar": log.totalPayment,
                }));

                if(dataToExport.length === 0){
                    showNotification("Tidak ada data untuk diunduh pada rentang tanggal ini.", true);
                    return;
                }

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Rekap Transaksi");
                
                worksheet["!cols"] = [ { wch: 15 }, { wch: 25 }, { wch: 25 }, { wch: 30 }, { wch: 20 }, { wch: 20 }, { wch: 20 } ];

                XLSX.writeFile(workbook, `Rekap_Transaksi_${startDateInput.value}_sd_${endDateInput.value}.xlsx`);
            }
            
            function downloadRecapPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape');
                const filteredData = getFilteredRecapData();

                if(filteredData.length === 0){
                    showNotification("Tidak ada data untuk diunduh pada rentang tanggal ini.", true);
                    return;
                }
                
                const tableData = filteredData.map(log => [
                    log.transactionDate,
                    log.taxpayerName,
                    log.businessName,
                    log.taxName,
                    formatFullCurrency(log.amount),
                    formatFullCurrency(log.fineAmount),
                    formatFullCurrency(log.totalPayment)
                ]);
                
                const totalAmount = filteredData.reduce((sum, log) => sum + log.totalPayment, 0);
                const totalRow = [
                    { content: 'TOTAL', colSpan: 6, styles: { fontStyle: 'bold', fillColor: '#f0f0f0', halign: 'center' } },
                    { content: formatFullCurrency(totalAmount), styles: { fontStyle: 'bold', halign: 'right', fillColor: '#f0f0f0' } },
                ];

                doc.setFontSize(18);
                doc.text("Rekapitulasi Transaksi Realisasi", 14, 22);
                doc.setFontSize(11);
                doc.setTextColor(100);
                const dateRange = `Periode: ${startDateInput.value || 'Semua'} s/d ${endDateInput.value || 'Semua'}`;
                doc.text(dateRange, 14, 29);

                doc.autoTable({
                    head: [['Tanggal', 'Nama WP', 'Nama Usaha', 'Jenis Pajak', 'Jumlah Pokok', 'Denda', 'Total Bayar']],
                    body: tableData,
                    foot: [totalRow],
                    startY: 35,
                    theme: 'grid',
                    headStyles: { fillColor: [22, 160, 133], textColor: 255 },
                    footStyles: { textColor: 0, fontStyle: 'bold' },
                    styles: { halign: 'left', fontSize: 8 },
                    columnStyles: {
                        4: { halign: 'right' },
                        5: { halign: 'right' },
                        6: { halign: 'right' },
                    }
                });

                doc.save(`Rekap_Transaksi_${startDateInput.value}_sd_${endDateInput.value}.pdf`);
            }


            function initDashboard() {
                btnDashboard.addEventListener('click', () => switchView('dashboard'));
                btnInput.addEventListener('click', () => switchView('input'));
                btnRecap.addEventListener('click', () => switchView('recap'));
                
                // Main Dashboard Download Menu
                downloadMenuButton.addEventListener('click', () => downloadMenu.classList.toggle('hidden'));
                downloadXlsxBtn.addEventListener('click', (e) => { e.preventDefault(); downloadXLSX(); downloadMenu.classList.add('hidden'); });
                downloadPdfBtn.addEventListener('click', (e) => { e.preventDefault(); downloadPDF(); downloadMenu.classList.add('hidden'); });
                
                // Recap Page Download Menu
                recapDownloadMenuButton.addEventListener('click', () => recapDownloadMenu.classList.toggle('hidden'));
                recapDownloadXlsxBtn.addEventListener('click', (e) => { e.preventDefault(); downloadRecapXLSX(); recapDownloadMenu.classList.add('hidden'); });
                recapDownloadPdfBtn.addEventListener('click', (e) => { e.preventDefault(); downloadRecapPDF(); recapDownloadMenu.classList.add('hidden'); });

                // Close dropdowns when clicking outside
                window.addEventListener('click', function(e) {
                    if (!downloadMenuButton.contains(e.target) && !downloadMenu.contains(e.target)) {
                        downloadMenu.classList.add('hidden');
                    }
                    if (!recapDownloadMenuButton.contains(e.target) && !recapDownloadMenu.contains(e.target)) {
                        recapDownloadMenu.classList.add('hidden');
                    }
                });
                
                // Recap date filters
                startDateInput.addEventListener('change', filterAndRenderRecap);
                endDateInput.addEventListener('change', filterAndRenderRecap);

                realizationTaxTypeSelect.addEventListener('change', updateSubTaxOptions);

                document.querySelectorAll('.sortable').forEach(header => {
                    header.addEventListener('click', () => {
                        const key = header.getAttribute('data-sort-key');
                        let direction = 'ascending';
                        if (sortConfig.key === key && sortConfig.direction === 'ascending') direction = 'descending';
                        sortConfig = { key, direction };
                        renderTable();
                        updateSortIcons();
                    });
                });

                formTarget.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const inputs = targetInputFields.querySelectorAll('input');
                    inputs.forEach(input => {
                        const taxId = parseInt(input.dataset.id);
                        const newTarget = parseInt(input.value);
                        const taxItem = taxData.find(t => t.id === taxId);
                        if (taxItem && !isNaN(newTarget)) {
                            taxItem.target = newTarget;
                        }
                    });
                    renderAll();
                    showNotification('Data target berhasil diperbarui!');
                });

                formRealization.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const taxId = parseInt(realizationTaxTypeSelect.value);
                    const amount = parseInt(realizationAmountInput.value);
                    const fineAmount = parseInt(fineAmountInput.value) || 0;
                    const totalPayment = amount + fineAmount;
                    const taxpayerName = taxpayerNameInput.value;
                    const businessName = businessNameInput.value;
                    const transactionDate = document.getElementById('transaction-date').value;
                    const paymentMethod = document.getElementById('payment-method').value;
                    const taxDescription = document.getElementById('tax-description').value;
                    const subTax = subTaxTypeSelect.value;

                    if (isNaN(amount) || amount < 0) {
                        showNotification('Jumlah realisasi tidak valid!', true);
                        return;
                    }
                    if (!transactionDate) {
                        showNotification('Tanggal transaksi harus diisi!', true);
                        return;
                    }
                     if (!taxpayerName || !businessName) {
                        showNotification('Nama Wajib Pajak dan Nama Usaha harus diisi!', true);
                        return;
                    }

                    const taxItem = taxData.find(t => t.id === taxId);
                    if (taxItem) {
                        taxItem.realization += totalPayment;
                    }
                    
                    const newTransaction = {
                        id: Date.now(), // Unique ID for deletion
                        taxId: taxId,
                        taxName: taxItem.name,
                        subTax: subTax || 'N/A',
                        amount: amount,
                        fineAmount: fineAmount,
                        totalPayment: totalPayment,
                        taxpayerName: taxpayerName,
                        businessName: businessName,
                        transactionDate: transactionDate,
                        paymentMethod: paymentMethod,
                        taxDescription: taxDescription,
                    };
                    transactionLog.push(newTransaction);
                    
                    renderAll();
                    showNotification(`Realisasi untuk ${taxItem.name} berhasil ditambahkan!`);
                    formRealization.reset();
                    transactionDateInput.valueAsDate = new Date();
                    updateSubTaxOptions();
                });
                
                recapTableBody.addEventListener('click', function(e) {
                    const deleteButton = e.target.closest('.delete-transaction-btn');
                    if (deleteButton) {
                        const transactionId = parseInt(deleteButton.dataset.id);
                        showDeleteModal(transactionId);
                    }
                });

                confirmDeleteBtn.addEventListener('click', deleteTransaction);
                cancelDeleteBtn.addEventListener('click', hideDeleteModal);


                renderAll();
                switchView('dashboard');
            }
        });
    </script>

</body>
</html>
